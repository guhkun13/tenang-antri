<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Board - TenangAntri</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .now-serving {
            animation: flash 2s infinite;
        }
        .ticket-card {
            transition: all 0.5s ease;
        }
        .ticket-card.new {
            animation: slideIn 0.5s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen text-white">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <i class="fas fa-tv text-3xl text-blue-400 mr-4"></i>
                <div>
                    <h1 class="text-2xl font-bold">Sedang Melayani</h1>
                    <p class="text-gray-400 text-sm">TenangAntri</p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-3xl font-bold" id="clock">--:--:--</p>
                <p class="text-gray-400" id="date">Loading...</p>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- Currently Serving -->
        <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-300 mb-4">
                    <i class="fas fa-bullhorn mr-2 text-yellow-400"></i>Sedang Melayani
                </h2>
            
            {{if .Tickets}}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="tickets-grid">
                {{range .Tickets}}
                <div class="ticket-card bg-gradient-to-br from-gray-800 to-gray-700 rounded-2xl p-6 border-2"
                     style="border-color: '{{.ColorCode}}';">
                    <div class="flex justify-between items-start mb-4">
                        <span class="text-gray-400 text-sm">Loket {{.CounterNumber}}</span>
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-400 text-sm mb-1">Nomor Tiket</p>
                        <h3 class="text-5xl font-bold" style="color: '{{.ColorCode}}';">{{.TicketNumber}}</h3>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-600 flex justify-between items-center">
                        <span class="px-3 py-1 rounded-full text-xs font-medium text-white"
                              style="background-color: '{{.ColorCode}}';">
                            {{.CategoryPrefix}}
                        </span>
                        <span class="text-green-400 text-sm font-medium">
                            <i class="fas fa-check-circle mr-1"></i>Melayani
                        </span>
                    </div>
                </div>
                {{end}}
            </div>
            {{else}}
            <div class="bg-gray-800 rounded-2xl p-12 text-center">
                <div class="w-24 h-24 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-pause text-4xl text-gray-500"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-400">Tidak ada tiket yang dilayani</h3>
                <p class="text-gray-500 mt-2">Menunggu pelanggan berikutnya...</p>
            </div>
            {{end}}
        </div>

        <!-- Queue Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Waiting by Category -->
            <div class="bg-gray-800 rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-list-ol mr-2 text-blue-400"></i>Menunggu Berdasarkan Kategori
                </h3>
                <div id="category-stats" class="space-y-3">
                    <!-- Will be populated by WebSocket -->
                    <p class="text-gray-500 text-center py-4">Memuat...</p>
                </div>
            </div>

                <!-- Counter Status -->
            <div class="bg-gray-800 rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-desktop mr-2 text-green-400"></i>Status Loket
                </h3>
                <div id="counter-stats" class="space-y-3">
                    {{range .Counters}}
                    <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg">
                        <span class="font-medium">{{.Name}}</span>
                        <span class="px-3 py-1 rounded-full text-xs font-medium
                            {{if not .IsActive}} bg-red-500 text-white
                            {{else if eq .Status "active"}} bg-green-500 text-white
                            {{else if eq .Status "paused"}} bg-orange-500 text-white
                            {{else}} bg-gray-500 text-white{{end}}">
                            {{if not .IsActive}} Nonaktif
                            {{else}}{{.Status}}{{end}}
                        </span>
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Today's Stats -->
            <div class="bg-gray-800 rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-chart-bar mr-2 text-purple-400"></i>Statistik Hari Ini
                </h3>
                <div id="today-stats" class="grid grid-cols-2 gap-4">
                    <div class="text-center p-3 bg-gray-700 rounded-lg">
                        <p class="text-2xl font-bold text-blue-400" id="total-tickets">--</p>
                        <p class="text-sm text-gray-400">Total</p>
                    </div>
                    <div class="text-center p-3 bg-gray-700 rounded-lg">
                        <p class="text-2xl font-bold text-green-400" id="completed-tickets">--</p>
                        <p class="text-sm text-gray-400">Completed</p>
                    </div>
                    <div class="text-center p-3 bg-gray-700 rounded-lg">
                        <p class="text-2xl font-bold text-yellow-400" id="waiting-tickets">--</p>
                        <p class="text-sm text-gray-400">Waiting</p>
                    </div>
                    <div class="text-center p-3 bg-gray-700 rounded-lg">
                        <p class="text-2xl font-bold text-purple-400" id="avg-wait">--</p>
                        <p class="text-sm text-gray-400">Rata-rata Tunggu</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 border-t border-gray-700 mt-8">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <p class="text-gray-400 text-sm">
                <i class="fas fa-info-circle mr-1"></i>
                Silakan menuju ke loket saat nomor Anda dipanggil
            </p>
            <div class="flex items-center space-x-4 text-sm text-gray-400">
                <span><i class="fas fa-wifi mr-1 text-green-400"></i>Pembaruan Langsung</span>
            </div>
        </div>
    </footer>

    <script>
        // Clock
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('id-ID');
            document.getElementById('date').textContent = now.toLocaleDateString('id-ID', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
        updateClock();
        setInterval(updateClock, 1000);

        // Fetch initial stats
        async function fetchStats() {
            try {
                const response = await fetch('/display/stats');
                const data = await response.json();
                document.getElementById('total-tickets').textContent = data.total_tickets_today || 0;
                document.getElementById('completed-tickets').textContent = data.tickets_by_status?.completed || 0;
                document.getElementById('waiting-tickets').textContent = data.waiting_tickets || 0;
                document.getElementById('avg-wait').textContent = data.avg_wait_time ? 
                    Math.round(data.avg_wait_time / 60) + 'm' : '--';
            } catch (error) {
                console.error('Gagal mengambil statistik:', error);
            }
        }
        fetchStats();

        // Fetch waiting by category
        async function fetchCategoryStats() {
            try {
                const response = await fetch('/display/waiting');
                const data = await response.json();
                const container = document.getElementById('category-stats');
                container.innerHTML = data.map(cat => `
                    <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg">
                        <div class="flex items-center">
                            <span class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold mr-3"
                                  style="background-color: ${cat.color_code};">
                                ${cat.prefix}
                            </span>
                            <span>${cat.category_name}</span>
                        </div>
                        <span class="text-xl font-bold" style="color: ${cat.color_code};">${cat.waiting_count}</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Gagal mengambil statistik kategori:', error);
            }
        }
        fetchCategoryStats();

        // WebSocket for real-time updates
        const ws = new WebSocket('ws://' + window.location.host + '/ws');
        
        ws.onopen = function() {
            console.log('WebSocket connected');
        };
        
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log('WebSocket message:', data);
            
            if (data.type === 'display_update' || data.type === 'ticket_update' || data.type === 'stats_update') {
                // Reload page to show updates
                window.location.reload();
            }
        };
        
        ws.onerror = function(error) {
            console.error('Terjadi kesalahan WebSocket:', error);
        };
        
        ws.onclose = function() {
            console.log('WebSocket terputus, mencoba ulang dalam 5s...');
            setTimeout(() => window.location.reload(), 5000);
        };

        // Auto-refresh as fallback
        setInterval(() => {
            fetchStats();
            fetchCategoryStats();
        }, 10000);
    </script>
</body>
</html>
